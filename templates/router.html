<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>{{ app_name }} – Tool Router</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Shared palette for highlights + tool pills */
    .tool-span {
      padding: 0 2px;
      border-radius: 0.25rem;
    }
    .tool-web_search { background: #fef3c7; }        /* amber-100 */
    .tool-arxiv_search { background: #e0f2fe; }      /* sky-100 */
    .tool-wikipedia_summary { background: #dcfce7; } /* green-100 */
    .tool-weather_lookup { background: #fce7f3; }    /* pink-100 */
    .tool-connector_lookup { background: #ede9fe; }  /* violet-100 */
    .tool-python_eval { background: #ffedd5; }       /* orange-100 */

    /* Pills for tool names, reusing same color palette */
    .tool-pill {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.1rem 0.5rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 600;
      border: 1px solid rgba(148, 163, 184, 0.7); /* slate-400-ish */
    }
    .tool-pill-web_search { background: #fef3c7; color: #92400e; }        /* amber-700 */
    .tool-pill-arxiv_search { background: #e0f2fe; color: #0369a1; }      /* sky-700 */
    .tool-pill-wikipedia_summary { background: #dcfce7; color: #166534; } /* green-700 */
    .tool-pill-weather_lookup { background: #fce7f3; color: #9d174d; }    /* pink-700 */
    .tool-pill-connector_lookup { background: #ede9fe; color: #5b21b6; }  /* violet-700 */
    .tool-pill-python_eval { background: #ffedd5; color: #9a3412; }       /* orange-700 */
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <div class="max-w-5xl mx-auto p-6">
    <!-- Header -->
    <header class="mb-6 flex flex-col sm:flex-row items-center sm:items-end justify-between gap-3">
      <div class="flex items-center gap-4">
        <div class="w-12 h-12 rounded-2xl bg-indigo-600 flex items-center justify-center shadow-md">
          <span class="text-white font-bold text-xl">T</span>
        </div>
        <div>
          <h1 class="text-3xl font-extrabold tracking-tight text-gray-900">
            LLM Tool Router <span class="text-indigo-600">– OpenAI</span>
          </h1>
          <p class="text-gray-600 text-sm sm:text-base mt-1">
            Type a query, see which tools the router activates, which spans trigger them, and inspect each tool response.
          </p>
        </div>
      </div>
    </header>

    <!-- Available tools / models info -->
    <section class="mb-4 bg-white border border-gray-100 rounded-2xl shadow-sm p-4 text-xs sm:text-sm">
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
        <div>
          <h2 class="font-semibold text-gray-800 mb-1">Tools available</h2>
          <p class="text-gray-500 mb-2">The router can activate these tools based on your query:</p>
          <div class="flex flex-wrap gap-1.5">
            <span class="tool-pill tool-pill-web_search">web_search</span>
            <span class="tool-pill tool-pill-arxiv_search">arxiv_search</span>
            <span class="tool-pill tool-pill-wikipedia_summary">wikipedia_summary</span>
            <span class="tool-pill tool-pill-weather_lookup">weather_lookup</span>
            <span class="tool-pill tool-pill-connector_lookup">connector_lookup</span>
            <span class="tool-pill tool-pill-python_eval">python_eval</span>
          </div>
        </div>
        <div>
          <h2 class="font-semibold text-gray-800 mb-1">Routing model</h2>
          <p class="text-gray-500 mb-1">
            Choose which OpenAI model performs the routing and tool-style responses.
          </p>
          <p class="text-gray-500 text-xs">
            Try a smaller model for quick routing, or a stronger one for more nuanced tool selection.
          </p>
        </div>
      </div>
    </section>

    <!-- Input card -->
    <section class="bg-white rounded-2xl shadow p-5 border border-gray-100">
      <label for="query" class="block text-sm font-medium text-gray-700 mb-1">
        Query
      </label>
      <textarea
        id="query"
        rows="3"
        class="w-full rounded-xl border-gray-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm p-3"
        placeholder="Example: Find recent papers on diffusion models and tell me the weather in Bogotá tomorrow."
      ></textarea>

      <!-- Model + Example prompts row -->
      <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-4">

        <!-- Model selector -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">
            Routing model
          </label>
          <select
            id="router-model"
            class="w-full rounded-xl border-gray-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm p-2.5"
          >
            <option value="gpt-4.1-mini" selected>gpt-4.1-mini (fast, default)</option>
            <option value="gpt-4o-mini">gpt-4o-mini (strong)</option>
            <option value="gpt-4.1">gpt-4.1 (reasoning)</option>
            <option value="gpt-4o">gpt-4o (highest quality)</option>
          </select>
        </div>

        <!-- Example prompts -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">
            Example prompts
          </label>
          <select
            id="example-prompts"
            class="w-full rounded-xl border-gray-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm p-2.5"
          >
            <option value="">-- choose an example --</option>
            <option value="Find recent papers on diffusion models and summarize their main contributions.">
              LLM + Arxiv example
            </option>
            <option value="What is the weather in Bogotá tomorrow and give me a short explanation of El Niño?">
              Weather + Wikipedia
            </option>
            <option value="Look up the price of Bitcoin today and find one related academic paper.">
              Web + Arxiv
            </option>
            <option value="Evaluate 12*(5+9)/3 and explain the reasoning.">
              Python eval
            </option>
            <option value="Search my reports for last month and summarize key insights.">
              Connector lookup
            </option>
          </select>
        </div>

      </div>

      <div class="mt-3 flex items-center justify-between gap-3">
        <button
          id="btn-analyze"
          class="inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700 text-sm font-medium shadow-sm disabled:opacity-60 disabled:cursor-default"
        >
          <span>Analyze query & run tools</span>
        </button>
        <div
          id="status"
          class="text-xs text-gray-500 min-h-[1.5rem] text-right"
        ></div>
      </div>
    </section>

    <!-- Results: highlights + tools list -->
    <section class="mt-6 grid grid-cols-1 lg:grid-cols-2 gap-4">
      <!-- Highlighted query -->
      <div class="bg-white rounded-2xl shadow p-5 border border-gray-100">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-sm font-semibold text-gray-800 uppercase tracking-wide">
            Highlighted query
          </h2>
          <span class="text-[11px] text-gray-400">
            Colored spans show which text triggered each tool.
          </span>
        </div>
        <div
          id="highlighted"
          class="border border-gray-200 rounded-xl bg-slate-50 px-3 py-3 min-h-[72px] text-sm leading-relaxed whitespace-pre-wrap"
        ></div>
      </div>

      <!-- Tools detected + meta -->
      <div class="bg-white rounded-2xl shadow p-5 border border-gray-100">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-sm font-semibold text-gray-800 uppercase tracking-wide">
            Tools detected
          </h2>
          <span class="text-[11px] text-gray-400">
            Auto = auto-triggered, Manual = user-controlled.
          </span>
        </div>
        <ul id="tool-list" class="space-y-3 text-sm"></ul>
      </div>
    </section>

    <!-- Tool responses panel -->
    <section class="mt-6">
      <div class="bg-white rounded-2xl shadow p-5 border border-gray-100">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-sm font-semibold text-gray-800 uppercase tracking-wide">
            Tool responses
          </h2>
          <span class="text-[11px] text-gray-400">
            Each card shows the response produced for that tool.
          </span>
        </div>
        <div id="tool-outputs" class="space-y-4 text-sm"></div>
      </div>
    </section>
  </div>

  <script>
    const queryEl = document.getElementById("query");
    const btnAnalyze = document.getElementById("btn-analyze");
    const statusEl = document.getElementById("status");
    const highlightedEl = document.getElementById("highlighted");
    const toolListEl = document.getElementById("tool-list");
    const toolOutputsEl = document.getElementById("tool-outputs");
    const exampleSelect = document.getElementById("example-prompts");
    const routerModelEl = document.getElementById("router-model");

    // Load example prompt into textarea
    exampleSelect.addEventListener("change", (e) => {
      const val = e.target.value.trim();
      if (val) {
        queryEl.value = val;
      }
    });

    btnAnalyze.addEventListener("click", async () => {
      const query = queryEl.value.trim();
      if (!query) {
        statusEl.textContent = "Please enter a query.";
        statusEl.classList.remove("text-red-600");
        statusEl.classList.add("text-gray-500");
        return;
      }

      const model = routerModelEl.value || "gpt-4.1-mini";

      btnAnalyze.disabled = true;
      statusEl.textContent = "Analyzing and running tools…";
      statusEl.classList.remove("text-red-600");
      statusEl.classList.add("text-gray-500");

      try {
        const res = await fetch("/tool-router/analyze", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ query, model })
        });

        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err.detail || `HTTP ${res.status}`);
        }

        const data = await res.json();
        renderHighlight(data.query, data.spans || []);
        renderTools(data.tools || []);
        renderToolOutputs(data.tools || []);
        statusEl.textContent = "Done.";
        statusEl.classList.remove("text-red-600");
        statusEl.classList.add("text-gray-500");
      } catch (err) {
        console.error(err);
        statusEl.textContent = "Error: " + err.message;
        statusEl.classList.remove("text-gray-500");
        statusEl.classList.add("text-red-600");
        highlightedEl.textContent = "";
        toolListEl.innerHTML = "";
        toolOutputsEl.innerHTML = "";
      } finally {
        btnAnalyze.disabled = false;
      }
    });

    function renderHighlight(query, spans) {
      highlightedEl.innerHTML = "";
      if (!query) return;

      // Sort spans by start index
      spans.sort((a, b) => a.start - b.start);

      let cursor = 0;
      spans.forEach((span) => {
        const start = span.start;
        const end = span.end;
        const tool = span.tool;

        if (start > cursor) {
          highlightedEl.appendChild(
            document.createTextNode(query.slice(cursor, start))
          );
        }

        const spanEl = document.createElement("span");
        spanEl.className = `tool-span tool-${tool}`;
        spanEl.title = tool;
        spanEl.textContent = query.slice(start, end);
        highlightedEl.appendChild(spanEl);

        cursor = end;
      });

      if (cursor < query.length) {
        highlightedEl.appendChild(
          document.createTextNode(query.slice(cursor))
        );
      }
    }

    function renderTools(tools) {
      toolListEl.innerHTML = "";
      if (!tools.length) {
        const li = document.createElement("li");
        li.className = "text-gray-400 text-sm";
        li.textContent = "No tools selected for this query.";
        toolListEl.appendChild(li);
        return;
      }

      tools.forEach((tool) => {
        const li = document.createElement("li");
        li.className = "border-l-4 border-gray-200 pl-3";

        const headerDiv = document.createElement("div");
        headerDiv.className = "flex items-center gap-2";

        // Color pill with same palette as query highlight
        const pill = document.createElement("span");
        pill.className = `tool-pill tool-pill-${tool.name}`;
        pill.textContent = tool.name;

        const badge = document.createElement("span");
        badge.className =
          "inline-flex items-center px-2 py-0.5 rounded-full text-[11px] border text-gray-700 bg-gray-50 border-gray-200";
        badge.textContent = tool.auto_trigger ? "auto" : "manual";

        headerDiv.appendChild(pill);
        headerDiv.appendChild(badge);

        const reasonDiv = document.createElement("div");
        reasonDiv.className = "mt-1 text-xs text-gray-600";
        reasonDiv.textContent = tool.reason;

        const descDiv = document.createElement("div");
        descDiv.className = "mt-0.5 text-xs text-gray-500";
        descDiv.textContent = tool.description;

        li.appendChild(headerDiv);
        li.appendChild(reasonDiv);
        li.appendChild(descDiv);

        toolListEl.appendChild(li);
      });
    }

    function renderToolOutputs(tools) {
      toolOutputsEl.innerHTML = "";
      if (!tools.length) {
        const div = document.createElement("div");
        div.className = "text-gray-400 text-sm";
        div.textContent = "No tools executed for this query.";
        toolOutputsEl.appendChild(div);
        return;
      }

      let hasAny = false;

      tools.forEach((tool) => {
        if (!tool.result_preview) return;
        hasAny = true;

        const card = document.createElement("div");
        card.className = "border border-gray-200 rounded-xl p-3 bg-slate-50";

        const header = document.createElement("div");
        header.className = "flex items-center justify-between mb-1";

        const pill = document.createElement("span");
        pill.className = `tool-pill tool-pill-${tool.name}`;
        pill.textContent = tool.name;

        const mode = document.createElement("span");
        mode.className =
          "inline-flex items-center px-2 py-0.5 rounded-full text-[11px] border text-gray-700 bg-white border-gray-200";
        mode.textContent = tool.auto_trigger ? "auto" : "manual";

        header.appendChild(pill);
        header.appendChild(mode);

        const body = document.createElement("div");
        body.className = "text-xs text-gray-800 whitespace-pre-wrap";
        body.textContent = tool.result_preview;

        card.appendChild(header);
        card.appendChild(body);

        toolOutputsEl.appendChild(card);
      });

      if (!hasAny) {
        const div = document.createElement("div");
        div.className = "text-gray-400 text-sm";
        div.textContent = "Tools were selected but no responses were produced.";
        toolOutputsEl.appendChild(div);
      }
    }
  </script>
</body>
</html>
